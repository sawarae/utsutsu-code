name: Release Windows Build

# NOTE: リリースは feature/win ブランチから行う（mainではない）。
# タグは feature/win の HEAD に付けて push する。
# 例: git tag v0.04 feature/win && git push origin v0.04

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

defaults:
  run:
    shell: bash

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.x"
          cache: true

      - name: Install dependencies
        working-directory: mascot
        run: flutter pub get

      - name: Download model files
        run: python3 .claude/skills/tsukuyomi-setup/setup_helper.py download-models

      - name: Build Windows release
        working-directory: mascot
        run: flutter build windows --release

      - name: Copy model and config files to build output
        working-directory: mascot
        run: |
          RELEASE=build/windows/x64/runner/Release/data
          mkdir -p "$RELEASE/models/blend_shape"
          mkdir -p "$RELEASE/models/blend_shape_mini"
          mkdir -p "$RELEASE/config"
          cp assets/models/blend_shape/emotions.toml "$RELEASE/models/blend_shape/"
          cp assets/models/blend_shape/*.inp "$RELEASE/models/blend_shape/"
          cp assets/models/blend_shape_mini/emotions.toml "$RELEASE/models/blend_shape_mini/"
          cp assets/models/blend_shape_mini/*.inp "$RELEASE/models/blend_shape_mini/"
          cp config/emotions.toml "$RELEASE/config/"
          rm -f build/windows/x64/runner/Release/native_assets.json

      - name: Create zip archive
        working-directory: mascot
        shell: pwsh
        run: |
          Compress-Archive `
            -Path 'build\windows\x64\runner\Release\*' `
            -DestinationPath 'build\utsutsu-code-windows.zip' `
            -Force

      - uses: actions/upload-artifact@v4
        with:
          name: utsutsu-code-windows
          path: mascot/build/utsutsu-code-windows.zip

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        working-directory: mascot
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "$GITHUB_REF_NAME" \
            build/utsutsu-code-windows.zip \
            --repo "$GITHUB_REPOSITORY" \
            --title "$GITHUB_REF_NAME" \
            --generate-notes
